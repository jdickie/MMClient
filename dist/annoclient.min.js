/*
* MM Client Front-End
* 
* @author: Grant Dickie
* 
* Uses MITHGrid - (c) 2011 MITH
* 
* This is a MITHGrid application of the OAC Annotation Repository framework produced by Asaf Bartov, Moritz Wissenbach,
* Marco Petris, and fellow from the University of Madrid. The server stores annotations and allows for querying across
* the already stored annotations with REST calls. Each Annotation, Body, and Target are given REST paths once stored
* at the server level. They can be retrieved using these calls. Note: the Ruby server returns a status of 302 when an
* annotation is successfully stored.
* 
* Locally, all annotations for a particular target are stored in the MITHGrid datastore. When a user enters a new 
* Target path, the annotations for that Target are automatically queried and retrived from the server via REST and
* put into the local data store in order to be queried against locally and provide faster service. Further use cases
* should be considered, where a user wants to query against more than just annotations on a the given Target.  
*
* Currently this is being only implemented to handle registration of a particular annotation to the server. 
*  
*/
var MITHGrid=MITHGrid||{},jQuery=jQuery||{},Interedition=Interedition||{},app=app||{};MITHGrid.globalNamespace("Interedition"),Interedition.namespace("Client"),Interedition.Client.namespace("AnnotationRegistration"),function(a,b,c){var d=c.Client.AnnotationRegistration.namespace("Controller");d.namespace("Rangy"),d.Rangy.initController=function(c){var d=b.Controller.initController("Interedition.Client.AnnotationRegistration.Controller.Rangy",c);c=d.options,d.applyBindings=function(b,d){var e=function(b){if(b.parentNode){var c=b.parentNode.childNodes,d,e;a.each(c,function(a,d){if(c[a].isSameNode(b))return a})}return null},f,g,h,i,j,k=b.locate("doc");a(k).mouseup(function(b){f=rangy.getSelection(),g=e(f.anchorNode),h=e(f.focusNode),j=a(f.anchorNode.parentNode).getPath(),i=a(f.focusNode.parentNode).getPath(),c.events.onMouseUp.fire([{sel:f,start:g,end:h,startNode:j,endNode:i}])})};return d},d.namespace("Buffer"),d.Buffer.initController=function(a){var c=b.Controller.initController("Interedition.Client.AnnotationRegistration.Controller.Buffer",a);a=c.options,c.applyBindings=function(a,b){};return c},d.namespace("Server"),d.Server.initController=function(c){var d=b.Controller.initController("Interedition.Client.AnnotationRegistration.Controller.Server",c),e,f;c=d.options,e=c.bodyURL,f=c.targetURL,d.applyBindings=function(b,d){var g=function(b){a.ajax({url:d.phpCDBypass,type:"POST",dataType:"text",data:{urlsend:d.post_anno_uri,datasend:JSON.stringify(b)},success:function(b){a(container).append("<p>"+b+"</p>")},error:function(a,b,c){console.log("error "+c+"  "+JSON.stringify(a))}})},h=function(){};b.registerBody=function(b){a.ajax({url:e,type:"POST",dataType:"text",data:b,success:function(a){c.events.onCallSuccess.fire(a)}})},b.registerTarget=function(b){a.ajax({url:f,type:"POST",dataType:"text",data:b,success:function(a){c.events.onCallSuccess.fire(a)}})},b.getConstraint=function(b){a.ajax({url:phpCDBypass,type:"POST",dataType:"text",data:{urlsend:d.constrain_anno_uri,datasend:JSON.stringify(b)},beforeSend:function(b){a("#targetmessage").empty().append("<p>Loading...</p>")},afterSend:function(){a("#targetmessage").empty()},success:function(b){a("body:first").trigger("TargetTextParsed",[txt,textURI,JSON.parse(b)])},complete:function(a,b){console.log(a)}})}};return d}}(jQuery,MITHGrid,Interedition),function(a,b){var c="Grant",d="http://87.106.12.254:3000/annotation_bodies",e="http://87.106.12.254:3000/annotations.json",f="http://87.106.12.254:8182/oac-constraint/create",g="http://87.106.12.254:8182/oac-constraint/match",h="src/callServer.php",i="",j="http://interedition.performantsoftware.com/annotation_bodies/86";b.Presentation.namespace("TextArea"),b.Presentation.TextArea.initPresentation=function(a,c){var d=b.Presentation.initPresentation("MITHGrid.Presentation.TextArea",a,c),e;d.rangy=c.controllers.rangy.bind(a,{}),d.server=c.controllers.server.bind(a,{}),e=function(a){var b,d,e;d=c.application.dataStores.MM.prepare([".type"]),e=d.evaluate("Target"),linepos="line="+a.start+","+a.end,textURI="http://quartos.org/lib/XMLDoc/viewXML.php?path=ham-1604-22276x-fol-c01.xml",cObj={uri:textURI,constraint:{position:linepos}},b={id:"target"+e.length,type:"Target",hasConstraint:a.hasConstraint||"",bodyType:"text",bodyContent:a.hasContent},c.application.dataStores.MM.loadItems([b])},d.rangy.events.onMouseUp.addListener(e);return d},b.Presentation.namespace("AnnoView"),b.Presentation.AnnoView.initPresentation=function(a,c){var d=b.Presentation.initPresentation("MITHGrid.Presentation.AnnoView",a,c);return d},Interedition.Client.AnnotationRegistration.namespace("MMClient"),Interedition.Client.AnnotationRegistration.MMClient.initApp=function(e,g){app=b.Application.initApp("Interedition.Client.AnnotationRegistration.MMClient",e,a.extend(!0,{},g,{viewSetup:'<div id="annoRegisterForm"><div id = "TargetDiv"><h2>Anno Target :</h2><br/><div id="textBodyTarget"></div>\t<div id="targetLoadTable"></div></div><div id="BodyTextArea"><h3>Put your annotation text here</h3><div id="targetID"></div><textarea id="bodyContent" cols="55" rows="20"></textarea><br/><button id="bodyLoad">Load Body</button><div id="bodyLoadTable"></div></div><div id="AnnoArea">\t<button id="submitAnno">Submit Annotation</button>\t<div id="annotationTable"><ul></ul></div></div></div><div id="servermessage"></div>',presentations:{TextAreaContent:{type:b.Presentation.TextArea,container:"#textBodyTarget",dataView:"TextContent",lenses:{text:function(a,b,c,d){var e={},f=c.getItem(d);a.empty().append("<p>"+f.content+"</p>");return e}},controllers:{rangy:"rangy",server:"server"}},AnnoDisp:{type:b.Presentation.AnnoView,container:"#bodyLoadTable",dataView:"AnnotationDisp",lenses:{annotation:function(b,d,e,f){var g={},h=e.getItem(f),i="<li>",j,k,l;i+="<p>"+h.id[0]+"</p>"+"<p>"+h.hasBody[0]+"</p>"+"<p>"+h.hasTargets[0]+"</p>"+"</li>",a("#"+a(b).attr("id")+" > ul").append(i),k=e.getItem(h.hasTargets[0]),j={author_uri:c,body_uri:h.hasBody[0],targets:[{uri:k.uri[0],constraint:k.constraint[0]}]},sendAnnoRequest(j),g.update=function(d){i+="<p>"+d.id[0]+"</p>"+"<p>"+d.hasBody[0]+"</p>"+"<p>"+d.hasTargets[0]+"</p>"+"</li>",a("#"+a(b).attr("id")+" > ul").append(i),k=e.getItem(d.hasTargets[0]),j={author_uri:c,body_uri:d.hasBody[0],targets:[{uri:k.id[0],constraint:k.constraint[0]}]},sendAnnoRequest(j)};return g}}}}})),app.validate=function(b){/^http/.test(b)?a("#validationImage").attr("src","images/001_06.png"):a("#validationImage").attr("src","images/001_05.png")},app.getBodyContent=function(){return a("#BodyTextArea > textarea").text()},app.getBodyURI=function(b){a.ajax({url:d,data:b,type:"POST",dataType:"text",success:function(c,d,e){var f=c,g,h;g=f.indexOf("<body>"),f=f.substring(g),h=f.indexOf("</b"),j=f.substring(0,h),j=j.replace(/\<body\>/,""),j=j.replace(/\n+/,""),j=j.replace(/\n+/,""),a.extend(b,{id:j,type:"body",uri:j}),app.dataStore.MM.loadItems([b])}})},app.parseExportAnno=function(b){var d={},e={},f=[],g={};e=app.dataStore.MM.getItem(b.hasBody),a.each(b.hasTarget,function(a,b){g=app.dataStore.MM.getItem(b),f.push(g)}),d={body:e,targets:f,author_uri:c};return d},app.parseInputAnno=function(b,c){var d=c.annotation,e={},f={},g=[],h={id:b,type:"annotation",hasBody:"",hasTarget:[],created:""};a.each(d.annotation_body,function(a,b){h.hasBody=b.uri,h.created=b.created_at,e={id:b.uri,type:"body",created:b.created_at,updated:b.updated_at?b.updated_at:""}}),a.each(d.annotation_target_instances,function(b,c){a.each(c.annotation_instance,function(b,c){h.hasTarget.push(c.annotation_target_info.uri),f={id:c.annotation_target_info.uri,type:"target",mime_type:c.annotation_target_info.mime_type},c.annotation_constraint!==undefined&&a.each(c.annotation_constraint,function(a,b){f[a]=b}),g.push(f)})})},app.checkHasTarget=function(a){var b={},c=app.dataStore.MM.prepare(["target.uri"]),d=c.evaluate([a]);!d.length},app.getTargetSelection=function(a,b,c,d){var e={},f,g=app.dataStore.MM.prepare([".type='target'"]);f=g.length,i="t"+Math.ceil(Math.random()*100),e={id:i,uri:c,type:"target",content:b,mime_type:"text/html",constraint:d.constraint},app.dataStore.MM.loadItems([e])},app.registerConstraint=function(b,c,d,e){var g={},i="line="+d+","+e,j=c.getAllRanges(),k=c+"",l=app.dataStore.MM.prepare(['.type="text"']),m="http://quartos.org/lib/XMLDoc/viewXML.php?path=ham-1604-22276x-fol-c01.xml";g={uri:m,constraint:{position:i}},a.ajax({url:h,type:"POST",dataType:"text",data:{urlsend:f,datasend:JSON.stringify(g)},beforeSend:function(b){a("#targetmessage").empty().append("<p>Loading...</p>")},afterSend:function(){a("#targetmessage").empty()},success:function(b){console.log("success reached "+b),a("body:first").trigger("TargetTextParsed",[k,m,JSON.parse(b)])},complete:function(a,b){console.log(a)}})},app.ready(function(){a("#TargetURI > input").focusout(function(b){b.preventDefault(),validate(a(this).val())}),a("#servermessage").bind("ajaxStart",function(){var b=parseInt(a(this).css("top"),10);a(this).css("top",b+a(document).scrollTop()),a(this).empty().append("<p>Loading...</p>").show()}),a("#servermessage").bind("ajaxComplete",function(){a(this).empty().hide()}),a("#bodyLoad").click(function(a){a.preventDefault();var b=getBodyContent(),c="text/html";bodyObj={content:b,mime_type:c};var d=getBodyURI(bodyObj)}),a("#submitAnno").click(function(a){a.preventDefault();var b=new Date,c="time:"+b.getMonth()+":"+b.getDate()+"::"+b.getHours()+":"+b.getMinutes(),d={id:"madeupID",type:"annotation",created:c,hasBody:j,hasTargets:[i]};app.dataStore.MM.loadItems([d]);return}),app.dataStore.MM.loadItems([{id:"http://quartos.org/lib/XMLDoc/viewXML.php?path=ham-1604-22276x-fol-c01.xml",type:"text",content:"King.And now princely Sonne Hamlet ,  \t\t\t\tExit.  What meanes these sad and melancholy moodes?For your intent going to Wittenberg ,Wee hold it most vnmeet and vnconuenient,Being the Ioy and halfe heart of your mother.Therefore let mee intreat you stay in Court,All Denmarkes hope our coosin and dearest Sonne.Ham.My lord, tis not the sable sute I weare:No nor the teares that still stand in my eyes,Nor the distracted hauiour in the visage,Nor all together mixt with outward semblance,Is equall to the sorrow of my heart,Him haue I lost I must of force forgoe,These but the ornaments and sutes of woe.KingThis shewes a louing care in you, Sonne Hamlet ,But you must thinke your father lost a father,That father dead, lost his, and so shalbe vntill theGenerall ending. Therefore cease laments,It is a fault gainst heauen, fault gainst the dead,A fault gainst nature, and in reasonsCommon course most certaine,"}])});return app}}(jQuery,MITHGrid),MITHGrid.defaults("Interedition.Client.AnnotationRegistration.Controller.Rangy",{bind:{events:{onMouseUp:null,onMouseDown:null}}}),MITHGrid.defaults("Interedition.Client.AnnotationRegistration.MMClient",{controllers:{rangy:{type:Interedition.Client.AnnotationRegistration.Controller.Rangy,selectors:{doc:""}},server:{type:Interedition.Client.AnnotationRegistration.Controller.Server,selectors:{}}},dataStores:{MM:{types:{annotation:{},body:{},target:{}},properties:{bodyType:{valueType:"text"},bodyContent:{valueType:"text"},targetURI:{valueType:"uri"},constraintURI:{valueType:"uri"},bodyURI:{valueType:"uri"}}}},dataViews:{TextContent:{types:["text"],dataStore:"MM"},TextBody:{types:["body"],dataStore:"MM"},TargetURI:{types:["target"],dataStore:"MM"},AnnotationDisp:{types:["annotation"],dataStore:"MM"}}});